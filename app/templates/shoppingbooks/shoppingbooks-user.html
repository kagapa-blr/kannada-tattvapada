<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Shopping Books - User</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <style>
    body {
      background: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .modal-img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
    }

    .book-detail-row {
      margin-bottom: 0.4rem;
    }

    .spinner-border {
      display: none;
      margin: 0 auto;
    }

    .price {
      font-size: 1.1rem;
      font-weight: bold;
      color: #28a745;
    }

    .discount {
      text-decoration: line-through;
      color: #dc3545;
      font-size: 0.9rem;
      margin-left: 0.5rem;
    }

    /* Search input */
    .search-wrapper {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 15px;
      gap: 5px;
      flex-wrap: wrap;
    }

    .search-wrapper input {
      max-width: 300px;
      height: 35px;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button {
      padding: 0.2em 0.8em;
    }

    @media (max-width: 576px) {
      .search-wrapper {
        justify-content: center;
      }
    }

    /* Modal improvements */
    #bookDetails img.modal-img {
      max-width: 100%;
      border-radius: 8px;
    }

    .book-detail-row {
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
    }

    .book-detail-row strong {
      width: 120px;
    }

    .book-prices {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.1rem;
    }

    .book-prices .price {
      font-weight: bold;
      color: #28a745;
    }

    .book-prices .discount {
      text-decoration: line-through;
      color: #dc3545;
      font-size: 0.95rem;
    }
  </style>
</head>

<body>
  <div class="container mt-5">
    <h2 class="mb-4 text-center text-primary fw-bold">üìö Available Books</h2>

    <!-- Search Input -->
    <div class="search-wrapper">
      <input type="text" id="manualSearchInput" class="form-control" placeholder="Search books...">
      <button class="btn btn-primary btn-sm" id="searchBtn">üîç Search</button>
    </div>

    <div class="text-center my-3">
      <div class="spinner-border text-primary" role="status" id="loadingSpinner">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <table id="booksTable" class="table table-striped table-bordered shadow-sm bg-white" style="width:100%">
      <thead class="table-dark">
        <tr>
          <th>#</th>
          <th>Title</th>
          <th>Author</th>
          <th>Price</th>
          <th>Stock</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <!-- Filled dynamically via JS -->
      </tbody>
    </table>
  </div>

  <!-- Book Info Modal -->
  <div class="modal fade" id="bookInfoModal" tabindex="-1" aria-labelledby="bookInfoLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="bookInfoLabel">üìñ Book Information</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="bookDetails" class="row g-3 align-items-start"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-success" id="buyNowBtn">Buy Now</button>
        </div>
      </div>
    </div>
  </div>



  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

  <script>
    $(document).ready(function () {
      const spinner = $('#loadingSpinner');

      const table = $('#booksTable').DataTable({
        serverSide: true,
        processing: true,
        ajax: {
          url: '/books/api/',
          type: 'GET',
          data: d => ({
            draw: d.draw,
            start: d.start,
            length: d.length,
            search_word: $('#manualSearchInput').val().trim()
          }),
          dataSrc: json => {
            spinner.hide();
            return json.data || [];
          },
          beforeSend: () => spinner.show(),
          error: () => {
            spinner.hide();
            alert('‚ùå Failed to load books.');
          }
        },
        columns: [
          { data: null, render: (data, type, row, meta) => meta.row + meta.settings._iDisplayStart + 1 },
          { data: 'title', defaultContent: '-' },
          { data: 'author_name', defaultContent: '-' },
          {
            data: null,
            render: function (row) {
              let price = row.price ? `‚Çπ${parseFloat(row.price).toFixed(2)}` : '-';
              let discount = row.discount_price ? `<span class="discount">‚Çπ${parseFloat(row.discount_price).toFixed(2)}</span>` : '';
              return `<span class="price">${price}</span> ${discount}`;
            }
          },
          { data: 'stock_quantity', defaultContent: '0' },
          {
            data: null,
            render: function (row) {
              return `<button class="btn btn-info btn-sm view-info" data-id="${row.id}">View</button>`;
            },
            orderable: false
          }
        ],
        lengthMenu: [10, 25, 50],
        pageLength: 10,
        language: { emptyTable: "üìö No books available at the moment." }
      });

      // Search button with validation
      $('#searchBtn').click(() => {
        const val = $('#manualSearchInput').val().trim();
        if (!val) return; // Do nothing if empty or only spaces
        table.ajax.reload();
      });

      // View Info Modal
      $('#booksTable tbody').on('click', '.view-info', function () {
        const bookId = $(this).data('id');
        $('#bookDetails').html('<div class="text-center w-100 my-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>');


        $.getJSON(`/books/api/${bookId}`, function (book) {
          const cover = book.cover_image_url || 'https://via.placeholder.com/250x350?text=No+Image';
          let html = `
    <div class="col-md-4 text-center">
      <img src="${cover}" class="modal-img" alt="Cover Image">
    </div>
    <div class="col-md-8">
      <h3>${book.title}</h3>
      <p class="book-detail-row"><strong>Subtitle:</strong> <span>${book.subtitle || '-'}</span></p>
      <p class="book-detail-row"><strong>Author:</strong> <span>${book.author_name || '-'}</span></p>
      <p class="book-detail-row book-prices">
        <strong>Price:</strong>
        <span class="price">‚Çπ${parseFloat(book.price).toFixed(2)}</span>
        ${book.discount_price ? `<span class="discount">‚Çπ${parseFloat(book.discount_price).toFixed(2)}</span>` : ''}
      </p>
      <p class="book-detail-row"><strong>Stock:</strong> <span>${book.stock_quantity}</span></p>
      <p class="book-detail-row"><strong>Pages:</strong> <span>${book.number_of_pages || '-'}</span></p>
      <p class="book-detail-row"><strong>Publisher:</strong> <span>${book.publisher_name || '-'}</span></p>
      <p class="book-detail-row"><strong>Language:</strong> <span>${book.language || '-'}</span></p>
      <p class="book-detail-row"><strong>Description:</strong> <span>${book.description || '-'}</span></p>
    </div>
  `;
          $('#bookDetails').html(html);
          $('#buyNowBtn').data('id', book.id);
          new bootstrap.Modal(document.getElementById('bookInfoModal')).show();
        }).fail(() => {
          $('#bookDetails').html('');
          alert('Failed to load book details.');
        });


      });

      // Buy Now
      $('#buyNowBtn').click(function () {
        const bookId = $(this).data('id');
        alert(`üõí Book with ID ${bookId} added to your cart! (Integrate real cart here)`);
      });
    });
  </script>
</body>

</html>