<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Shopping Books - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Noto Sans Kannada';
      font-size: 15px;
      line-height: 1.1;
      color: #2c2c2c;
    }

    .modal-lg {
      max-width: 800px;
    }

    #coverPreview {
      max-width: 150px;
      max-height: 200px;
      margin-top: 10px;
    }

    .spinner-border {
      display: none;
    }

    .table td,
    .table th {
      vertical-align: middle;
      text-align: center;
    }

    /* Button styles */
    .btn-primary {
      background-color: #1e88e5;
      border: none;
    }

    .btn-primary:hover {
      background-color: #1565c0;
    }

    .btn-success {
      background-color: #43a047;
      border: none;
    }

    .btn-success:hover {
      background-color: #2e7d32;
    }

    .btn-secondary {
      background-color: #757575;
      border: none;
    }

    .btn-secondary:hover {
      background-color: #424242;
    }

    /* Search input alignment */
    .top-controls {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
      align-items: center;
    }

    .search-group {
      display: flex;
      gap: 5px;
    }

    .search-group input,
    .search-group button {
      height: 38px;
    }

    @media (max-width: 576px) {
      .top-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .search-group {
        justify-content: flex-start;
      }
    }
  </style>
</head>

<body>
  <div class="container py-5">
    <h2 class="mb-4 text-center text-primary fw-bold">üìö Manage Books</h2>

    <div class="top-controls">
      <div class="btn-group">
        <button class="btn btn-success" id="addBookBtn">‚ûï Add New Book</button>
        <button class="btn btn-primary" id="autoFillBtn">üì• Auto Fill</button>
        <button class="btn btn-secondary" id="refreshBtn">üîÑ Refresh</button>
      </div>
      <div class="d-flex justify-content-end mb-3">
        <div class="d-flex" style="width: 300px; gap: 10px;">
          <input type="text" id="manualSearchInput" class="form-control form-control-sm" placeholder="Search books...">
          <button class="btn btn-primary btn-sm" id="searchBtn">üîç</button>
        </div>
      </div>



    </div>

    <div class="text-center my-3">
      <div class="spinner-border text-primary" role="status" id="loadingSpinner">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <table id="booksTable" class="table table-striped table-bordered w-100">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Cover</th>
          <th>Title</th>
          <th>Author</th>
          <th>Price</th>
          <th>Stock</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Modal: Add/Edit Book -->
  <div class="modal fade" id="bookModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <form id="bookForm">
          <div class="modal-header bg-light">
            <h5 class="modal-title fw-bold">üìò Book Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <input type="hidden" name="id" id="bookId">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Title *</label>
                <input type="text" class="form-control" name="title" placeholder="Enter book title" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Author</label>
                <input type="text" class="form-control" name="author_name" placeholder="Author name">
              </div>
            </div>

            <div class="row g-3 mt-2">
              <div class="col-md-3">
                <label class="form-label">Price *</label>
                <input type="number" step="0.01" class="form-control" name="price" required>
              </div>
              <div class="col-md-3">
                <label class="form-label">Discount Price</label>
                <input type="number" step="0.01" class="form-control" name="discount_price">
              </div>
              <div class="col-md-3">
                <label class="form-label">Stock *</label>
                <input type="number" class="form-control" name="stock_quantity" required>
              </div>
              <div class="col-md-3">
                <label class="form-label">Pages</label>
                <input type="number" class="form-control" name="number_of_pages">
              </div>
            </div>

            <div class="mb-3 mt-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" name="description" rows="3" placeholder="Short description..."></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">Cover Image</label>
              <input type="file" class="form-control" name="cover_file" id="coverFileInput">
              <img id="coverPreview" src="" alt="Cover Preview" class="d-none border mt-2 rounded">
            </div>
          </div>

          <div class="modal-footer">
            <button type="submit" class="btn btn-primary" id="saveBtn">üíæ Save</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal: Auto Fill from Tatvapada -->
  <div class="modal fade" id="autoFillModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="autoFillForm">
          <div class="modal-header bg-info text-white">
            <h5 class="modal-title">üì• Auto Fill from Tatvapada</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-info small">
              <strong>‚ÑπÔ∏è Notes:</strong> This will create books automatically from <code>Tatvapada</code> table.<br>
              - <strong>Title</strong> ‚Üí <code>tatvapadakosha_sheershike</code><br>
              - <strong>Author</strong> ‚Üí <code>tatvapadakarara_hesaru</code><br>
              - Other fields will be empty (you can update them later).
            </div>

            <div class="mb-3">
              <label class="form-label">Default Price (‚Çπ)*</label>
              <input type="number" step="0.01" class="form-control" name="default_price" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Default Stock</label>
              <input type="number" class="form-control" name="stock_quantity" value="0">
            </div>

            <div class="mb-3">
              <label class="form-label">Notes (Optional)</label>
              <textarea class="form-control" name="notes" rows="2" placeholder="Notes about this batch..."></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">üöÄ Auto Fill</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

  <script>
    $(function () {
      const spinner = $('#loadingSpinner');

      const table = $('#booksTable').DataTable({
        serverSide: true,
        processing: true,
        searching: false,
        ordering: false,
        ajax: {
          url: '/books/api/',
          type: 'GET',
          data: d => ({
            draw: d.draw,
            start: d.start,
            length: d.length,
            search_word: $('#manualSearchInput').val().trim() || ''
          }),
          dataSrc: json => {
            spinner.hide();
            return json.data || [];
          },
          beforeSend: () => spinner.show(),
          error: () => { spinner.hide(); alert('‚ùå Failed to load books.'); }
        },
        columns: [
          { data: null, render: (data, type, row, meta) => meta.row + meta.settings._iDisplayStart + 1 }, // Serial #
          { data: 'cover_image_url', render: data => data ? `<img src="${data}" width="50" class="rounded">` : '<span class="text-muted">No image</span>', orderable: false },
          { data: 'title', defaultContent: '-' },
          { data: 'author_name', defaultContent: '-' },
          { data: 'price', render: d => d ? `‚Çπ${parseFloat(d).toFixed(2)}` : '-' },
          { data: 'stock_quantity', defaultContent: '0' },
          {
            data: null, render: d => `
              <button class="btn btn-info btn-sm edit" data-id="${d.id}">‚úèÔ∏è Edit</button>
              <button class="btn btn-danger btn-sm delete" data-id="${d.id}">üóëÔ∏è Delete</button>
            `, orderable: false
          }
        ],
        lengthMenu: [10, 25, 50, 100],
        pageLength: 10,
        language: { emptyTable: "No books available." }
      });

      // Controls
      $('#refreshBtn').click(() => table.ajax.reload());
      $('#searchBtn').click(() => {
        const searchValue = $('#manualSearchInput').val().trim();
        if (!searchValue) {
          alert('Please enter a valid search term.');
          return;
        }
        table.ajax.reload();
      });


      $('#addBookBtn').click(() => { $('#bookForm')[0].reset(); $('#bookId').val(''); $('#coverPreview').attr('src', '').addClass('d-none'); new bootstrap.Modal('#bookModal').show(); });
      $('#autoFillBtn').click(() => { $('#autoFillForm')[0].reset(); new bootstrap.Modal('#autoFillModal').show(); });

      // Edit & Delete
      $('#booksTable').on('click', '.edit', function () {
        const id = $(this).data('id');
        $.getJSON(`/books/api/${id}`)
          .done(book => {
            $('#bookId').val(book.id);
            $('#bookForm [name="title"]').val(book.title);
            $('#bookForm [name="author_name"]').val(book.author_name);
            $('#bookForm [name="price"]').val(book.price);
            $('#bookForm [name="discount_price"]').val(book.discount_price);
            $('#bookForm [name="stock_quantity"]').val(book.stock_quantity);
            $('#bookForm [name="number_of_pages"]').val(book.number_of_pages);
            $('#bookForm [name="description"]').val(book.description);
            if (book.cover_image_url) $('#coverPreview').attr('src', book.cover_image_url).removeClass('d-none');
            new bootstrap.Modal('#bookModal').show();
          })
          .fail(() => alert('‚ùå Failed to fetch book details.'));
      });

      $('#booksTable').on('click', '.delete', function () {
        const id = $(this).data('id');
        if (confirm('Are you sure you want to delete this book?')) {
          $.ajax({ url: `/books/api/${id}`, type: 'DELETE', success: () => table.ajax.reload(), error: () => alert('‚ùå Failed to delete book.') });
        }
      });

      // Cover preview
      $('#coverFileInput').on('change', function () {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = e => $('#coverPreview').attr('src', e.target.result).removeClass('d-none');
          reader.readAsDataURL(file);
        }
      });

      // Save book
      $('#bookForm').on('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        const id = $('#bookId').val();
        const url = id ? `/books/api/${id}` : '/books/api/';
        const method = id ? 'PUT' : 'POST';
        $('#saveBtn').prop('disabled', true);
        spinner.show();

        $.ajax({ url, type: method, data: formData, processData: false, contentType: false })
          .done(() => { bootstrap.Modal.getInstance(document.getElementById('bookModal')).hide(); table.ajax.reload(); })
          .fail(() => alert('‚ùå Failed to save book.'))
          .always(() => { $('#saveBtn').prop('disabled', false); spinner.hide(); });
      });

      // Auto Fill
      $('#autoFillForm').on('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        spinner.show();

        $.ajax({ url: '/books/api/autofill', type: 'POST', data: formData, processData: false, contentType: false })
          .done(res => {
            alert(`‚úÖ ${res.created} books created.\n${res.errors?.length ? "Some errors:\n" + res.errors.join("\n") : ""}`);
            bootstrap.Modal.getInstance(document.getElementById('autoFillModal')).hide();
            table.ajax.reload();
          })
          .fail(() => alert('‚ùå Auto-fill failed.'))
          .always(() => spinner.hide());
      });

    });
  </script>
</body>

</html>